# Run Dart tests for liboqs_dart
#
# Trigger:
# - Push to main when library files change
# - After native library build completes
# - Manual dispatch

name: Tests

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'lib/**'
      - 'test/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
  workflow_run:
    workflows: ["Build liboqs Native Libraries"]
    types: [completed]
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest  # Native libraries are pre-built in bin/
    # Skip if triggered by failed build workflow
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup FVM and Flutter
        uses: ./.github/actions/setup-fvm

      - name: Install dependencies
        run: make get

      - name: Install lcov
        run: sudo apt-get install -y lcov

      - name: Analyze code
        run: make analyze ARGS="--fatal-infos"

      - name: Run tests with coverage
        run: |
          fvm dart test --coverage=coverage
          fvm dart run coverage:format_coverage --lcov --in=coverage --out=coverage/lcov.info --report-on=lib
          # Exclude auto-generated FFI bindings from coverage
          lcov --remove coverage/lcov.info 'lib/src/bindings/*' -o coverage/lcov.info

      - name: Calculate coverage percentage
        id: coverage
        run: |
          COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep 'lines' | sed 's/.*: //' | sed 's/%.*//')
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"

      - name: Update coverage badge
        if: github.ref == 'refs/heads/main'
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: ${{ vars.COVERAGE_GIST_ID }}
          filename: coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.percentage }}%
          valColorRange: ${{ steps.coverage.outputs.percentage }}
          minColorRange: 50
          maxColorRange: 90

      - name: Check formatting
        run: make format-check
